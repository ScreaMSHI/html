<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S C P-异常档案-优化版</title>
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Chart.js CDN 用于市场份额饼状图 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- 设置自定义 Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'anomaly-red': '#ff3366',
                        'anomaly-cyan': '#33ccff',
                        'liminal-bg': '#0a0a1a', /* 更深的背景色 */
                        'terminal-dark': '#0f0f1c', /* 终端模块背景色 */
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['\'Courier Prime\'', 'monospace'],
                    },
                    keyframes: {
                        shake: {
                            // 增加抖动幅度
                            '0%, 100%': { transform: 'translateX(0)' },
                            '10%, 30%, 50%, 70%, 90%': { transform: 'translateX(-2px)' },
                            '20%, 40%, 60%, 80%': { transform: 'translateX(2px)' },
                        },
                        // 轻微的故障抖动效果
                        glitchShake: { 
                            '0%, 100%': { transform: 'translate(0, 0)' },
                            '20%': { transform: 'translate(0.5px, -0.5px)' },
                            '40%': { transform: 'translate(-0.5px, 0.5px)' },
                            '60%': { transform: 'translate(0.5px, 0.5px)' },
                            '80%': { transform: 'translate(-0.5px, -0.5px)' },
                        },
                        textStream: { /* 数据流动画 */
                            '0%': { filter: 'hue-rotate(0deg)' },
                            '10%': { transform: 'translateY(0px) skewX(0deg)' },
                            '11%': { transform: 'translateY(-0.5px) skewX(1deg)', filter: 'hue-rotate(5deg)' },
                            '12%': { transform: 'translateY(0.5px) skewX(-1deg)' },
                            '13%': { transform: 'translateY(0px) skewX(0deg)', filter: 'hue-rotate(0deg)' },
                            '100%': { filter: 'hue-rotate(0deg)' },
                        },
                        // 扫描线轻微垂直抖动动画
                        scanlineJitter: {
                            '0%': { backgroundPosition: '0 0' },
                            '100%': { backgroundPosition: '0 4px' }
                        },
                        // 新增：缓慢明暗效果 (已增强)
                        subtlePulse: {
                            '0%, 100%': { 
                                'text-shadow': '0 0 10px #33ccff, 0 0 5px rgba(51, 204, 255, 0.5)' // 基础亮度
                            },
                            '50%': {
                                'text-shadow': '0 0 20px #33ccff, 0 0 12px rgba(51, 204, 255, 1.0)' // 增强：更大的范围和更高的不透明度
                            },
                        },
                    },
                    animation: {
                        shake: 'shake 0.1s infinite',
                        glitchShake: 'glitchShake 0.15s infinite alternate',
                        textStream: 'textStream 3s infinite linear',
                        scanlineJitter: 'scanlineJitter 0.5s infinite steps(10) alternate',
                        // 新增：应用缓慢脉冲动画
                        pulseSlow: 'subtlePulse 4s infinite ease-in-out', 
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Inter:wght@400;700&display=swap');

        /* 页面基础过渡设置 */
        #title-screen, #main-content {
            transition: opacity 1s ease-in-out;
        }

        /* 强制标题页占满一个手机屏幕的高度 */
        #title-screen {
            min-height: 100vh;
            width: 100%;
            /* 使用更深的背景色 */
            background-image: linear-gradient(135deg, #10101f 0%, #0a0a1a 100%);
            border-bottom: 4px solid #33ccff;
            position: fixed; 
            top: 0;
            left: 0;
        }

        /* 自定义滚动条指示器动画 */
        .scroll-indicator {
            animation: bounce 1.5s infinite;
        }

        /* 档案缩略图效果 */
        .archive-card {
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(51, 204, 255, 0.2);
            border-left: 4px solid transparent;
        }
        .archive-card:hover {
            border-left: 4px solid #33ccff;
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(51, 204, 255, 0.4);
        }
        
        details > summary::-webkit-details-marker {
            display: none;
        }
        
        /* 隐藏滚动条 */
        body::-webkit-scrollbar {
            display: none;
        }
        body {
            -ms-overflow-style: none;
            scrollbar-width: none;
            
            /* --------------------------------------------------- */
            /* --- 2. 添加全局蓝色背景衬线效果 --- */
            position: relative;
        }

        /* 全局蓝色扫描线 overlay (背景衬线) */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* 确保不影响点击事件 */
            z-index: 1; /* 位于内容下方，背景上方 */
            /* 修改：提高不透明度，让扫描线更明显 */
            opacity: 0.3; 
            
            /* 蓝色/青色扫描线图案 */
            background-image: repeating-linear-gradient(
                0deg, 
                rgba(51, 204, 255, 0.1), /* 浅色线 (Cyan) */
                rgba(51, 204, 255, 0.1) 1px, 
                transparent 1px, 
                transparent 4px /* 线之间的间距 */
            );
            background-size: 100% 5px; /* 设置重复图案的高度 */
        }

        /* Modal/Dialog Fade-in */
        dialog {
            animation: fadeIn 0.3s ease-out forwards;
            /* 保持 dialog 的 z-index 很高，确保它在所有 overlay 之上 */
            z-index: 1000; 
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* --------------------------------------------------- */
        /* --- 模块标题样式 (恢复竖线和辉光) --- */
        
        /* 模块/子标题容器的样式：恢复辉光和竖线边框 */
        .terminal-title { 
            position: relative;
            overflow: hidden; 
            background-color: #0a0a1a;
            z-index: 2; 
            /* 恢复：边框和辉光 */
            box-shadow: 0 0 10px rgba(51, 204, 255, 0.2); 
            border: 1px solid rgba(51, 204, 255, 0.1); 
            padding: 0.5rem 0 0.5rem 1.0rem; 
            margin-bottom: 2rem; 
        }

        /* 恢复：标题前的竖线装饰 */
        .terminal-title::after { 
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px; /* Vertical line width */
            height: 100%;
            background-color: #33ccff; /* anomaly-cyan */
            box-shadow: 0 0 10px #33ccff;
            z-index: 1;
        }
        
        /* 恢复：所有标题文本上的蓝色辉光 */
        .terminal-title span {
            text-shadow: 0 0 8px rgba(51, 204, 255, 0.7); 
            display: inline-block; 
        }
        
        /* H1 主标题特有样式 - 覆盖/定制 */
        .main-terminal-title {
            padding-left: 1.5rem; 
            padding-right: 1.5rem;
            padding-top: 1rem;
            padding-bottom: 1rem;
            text-align: center; 
            background-color: transparent; 
            /* 强制覆盖：移除边框和通用辉光 */
            border: none !important;
            box-shadow: none !important; 
        }

        /* 强制移除主标题的通用竖线伪元素 */
        .main-terminal-title::after { 
            content: none;
        }

        /* 终端机主模块的样式增强 (欢迎语部分) - 恢复辉光边框 */
        .terminal-box {
            background-color: #0f0f1c; 
            /* 恢复：蓝色边框和辉光 */
            border: 1px solid #33ccff; 
            box-shadow: 0 0 20px rgba(51, 204, 255, 0.4); 
            position: relative;
            overflow: hidden;
            padding-top: 1.5rem; 
        }

        /* --------------------------------------------------- */
        /* --- 1. 移除主标题的所有视觉效果 (故障抖动、辉光、扫描线) --- */
        
        /* 针对主标题的样式 (已修改: 添加缓慢脉冲辉光) */
        .main-terminal-title h1 {
            /* 应用缓慢脉冲辉光动画 */
            text-shadow: 0 0 10px #33ccff, 0 0 5px rgba(51, 204, 255, 0.5); /* 初始辉光 */
            animation: pulseSlow; 
            
            /* 确保主标题文本没有扫描线或其他装饰 */
            position: relative;
            display: inline-block; 
            z-index: 3; 
            padding: 0; 
            margin: 0; 
            background-color: transparent; 
        }
        
        /* --------------------------------------------------- */
        /* --- 补给仓库小标题样式 (Concise Terminal Look) --- */
        
        /* 移除辉光：物品小标题的块状背景、辉光和边框，只保留文本和 ID 的颜色 */
        .item-summary-title {
            display: inline-flex;
            align-items: center;
            padding: 0; /* 移除 padding */
            margin-left: 0; /* 移除负边距 */
            border-bottom: none; /* 移除底部细线 */
            box-shadow: none; /* 移除阴影 */
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        /* 鼠标悬停时增强效果: 移除所有悬停阴影和边框变化 */
        details:hover .item-summary-title {
            box-shadow: none; 
            border-bottom-color: transparent;
        }
        
        /* 标题文本本身使用更粗的字体，移除辉光 */
        .item-summary-title > span {
            font-weight: 700;
            font-family: 'Courier Prime', monospace;
            color: #fcd34d; /* yellow-300 */
            text-shadow: none; /* 移除辉光 */
        }

        /* 强调 A-XX ID 部分 - 移除辉光 */
        .item-summary-id {
            color: #33ccff; /* anomaly-cyan for A-series ID */
            margin-right: 0.5rem;
            font-weight: 700;
            text-shadow: none; /* 移除辉光 */
            padding-right: 0; 
            border-right: none;
        }

        /* B-系列物品标题和 ID 颜色（保留红色 ID） */
        .item-summary-title-b .item-summary-id {
            color: #ff3366; /* anomaly-red for B-series ID */
            text-shadow: none; /* 移除辉光 */
        }

        /* 统一 Details 容器的边框和阴影到 A-系列的标准（蓝色/灰色） */
        .item-container-b {
            border-color: #4b5563 !important; /* border-gray-700/50 */
            box-shadow: none !important; /* 移除可能的红色阴影 */
        }
        /* B-系列详情页的顶部边框改为灰色 */
        .item-container-b .border-t {
             border-top-color: #4b5563 !important; 
        }

        /* 密码输入框的抖动效果和错误视觉反馈 (增强) */
        .password-shake {
            animation: shake 0.2s 3;
            border-color: #ff3366 !important; /* 错误时显示红边框 */
            box-shadow: 0 0 10px #ff3366; /* 错误时显示红辉光 */
        }
        
        /* 模块 A/B 容器的特殊样式 */
        .module-indicator {
            transition: transform 0.3s ease;
        }
        
        /* 按钮加载状态专用样式，确保文本在进度条上可见 */
        #start-button.loading-state {
            /* 移除背景颜色，完全依赖 linear-gradient */
            background-color: transparent !important;
            /* 确保过渡不影响进度条动画 */
            transition: all 0.2s ease, background-image 0s; 
            /* 确保文本颜色是深色，与进度条的亮色形成对比 */
            color: #0a0a1a; 
            /* 移除悬停效果 */
            cursor: default;
        }
        /* 确保 span 文本在 loading 状态下层级高 */
        #start-button.loading-state #button-text {
            z-index: 10;
            position: relative;
            /* 允许文本背景是透明的，让背景渐变显示 */
            background-color: transparent; 
        }

    </style>
</head>
<body class="bg-liminal-bg text-gray-200 font-sans overflow-x-hidden">

    <!-- 1. 标题页面 (Title Screen) -->
    <div id="title-screen" class="flex flex-col items-center justify-center p-4 text-center">
        <div class="space-y-8 max-w-lg w-full">
            
            <!-- 主标题：已应用脉冲辉光效果 -->
            <div class="terminal-title main-terminal-title text-center rounded-lg">
                <!-- 移除内部的 <span> 标签 -->
                <h1 class="text-2xl md:text-4xl font-mono uppercase font-bold text-anomaly-cyan cursor-default">
                    [有限认知分部 // 数据检索终端]
                </h1>
            </div>

            <!-- 时间条 (数字快速变化) -->
            <div class="p-4 bg-gray-900 border-2 border-anomaly-cyan rounded-xl shadow-lg transition-all duration-500">
                <p class="text-xs text-anomaly-cyan mb-2">系统时间戳 | S Y S T E M - C L O C K</p>
                <!-- JS 会在 generateGlitchTime 中切换 text-anomaly-red/cyan 颜色，模拟不稳定 -->
                <div id="time-display" class="font-mono text-xl md:text-3xl text-anomaly-red">
                    <span id="date-component">0000-00-00</span>
                    <span class="text-white">_</span>
                    <span id="time-component">00:00:00</span>
                    <span id="ms-component" class="text-sm opacity-75">.000</span>
                </div>
            </div>

            <!-- 激活按钮：添加 relative 和 overflow-hidden，为进度条效果做准备 -->
            <button id="start-button" 
                    class="px-8 py-3 w-full bg-anomaly-cyan text-terminal-dark font-bold rounded-lg shadow-xl hover:bg-cyan-300 transition-transform active:scale-95 duration-200 uppercase font-mono tracking-widest text-lg relative overflow-hidden"
                    style="background-size: 100% 100%;">
                <span id="button-text">访问权限请求</span>
            </button>
            
            <!-- 移除旧的加载进度条容器 -->
            <div id="loading-container" class="mt-4 hidden">
                <!-- 旧的进度条内容已移除 -->
            </div>

            <!-- 加载完成后显示的向下箭头 -->
            <div id="scroll-indicator" class="hidden pt-12">
                <p class="text-sm font-mono text-gray-400 mb-2">[ ACCESS GRANTED ]</p>
                <svg class="scroll-indicator w-10 h-10 mx-auto text-anomaly-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </div>

        </div>
    </div>

    <!-- 2. 主内容区域 (初始隐藏) -->
    <main id="main-content" class="container mx-auto p-6 md:p-10 space-y-16 opacity-0 pointer-events-none relative">
        
        <!-- 导言 - 有限认知-数据检索终端 (恢复辉光边框) -->
        <div class="max-w-4xl mx-auto mb-12 p-4 md:p-6 rounded-lg shadow-2xl terminal-box">
            
            <!-- 更改：添加 ID，移除硬编码文本，由 JS 动态设置 -->
            <h2 id="welcome-greeting" class="text-lg md:text-xl font-bold font-mono text-anomaly-cyan mb-2 tracking-widest text-center px-2">
                <!-- JS will set content: 欢迎，特工 [RANDOM_CODE] 。您的访问操作已被记录。 -->
            </h2>

            <!-- 警示状态行 -->
            <p class="text-center font-mono text-sm text-yellow-400 animate-pulse mb-0">
                [ WARNING: LIMITED ACCESS RIGHTS. DATA INTEGRITY CHECK REQUIRED ]
            </p>

        </div>

        <!-- 模块一：补给仓库 -->
        <section>
            <!-- 模块标题：恢复竖线和辉光 -->
            <div class="terminal-title rounded-lg">
                <h1 class="text-2xl font-bold font-mono text-anomaly-cyan tracking-widest">
                    <span>补给仓库</span>
                </h1>
            </div>

            <!-- 购买须知 (PURCHASE NOTICE) -->
            <div class="bg-gray-800 p-4 mb-6 rounded-lg border border-gray-700 font-mono">
                <p class="text-sm text-anomaly-cyan mb-3">:: 购买须知 ::</p>
                <ul class="text-sm text-gray-400 space-y-2 list-none pl-0">
                    <!-- 规则 1: 补给价格限制 (已改为绿色小三角) -->
                    <li class="flex items-start">
                        <span class="text-green-400 mr-2 mt-px text-sm">►</span>
                        <span>
                            可购买的单个补给价格需小于等于参加外勤任务*10的嘉奖数量
                        </span>
                    </li>
                    <!-- 规则 2: 运费规定 (已改为绿色小三角) -->
                    <li class="flex items-start">
                        <span class="text-green-400 mr-2 mt-px text-sm">►</span>
                        <span>
                            如果该补给不是由您的小队取得，则购买时需要额外增加运费（A系列：1点嘉奖，B系列：2点嘉奖，运费不超过物品价格）
                        </span>
                    </li>
                    <!-- 规则 3: 最终解释权 (已改为绿色小三角) -->
                    <li class="flex items-start">
                        <span class="text-green-400 mr-2 mt-px text-sm">►</span>
                        <span>
                            价格和描述均有可能进行调整，有限认知分部经理拥有最终解释权
                        </span>
                    </li>
                </ul>
            </div>

            <!-- 统一的补给仓库容器 - 容器 ID 已设置，内容将由 JS 动态生成 -->
            <!-- 此处将包含两个可折叠的模块 A 和 模块 B -->
            <div id="supply-list-container" class="bg-gray-900 border border-anomaly-cyan/50 rounded-lg shadow-xl p-4 md:p-6 space-y-4 font-mono">
                <!-- 动态内容将在此处生成 -->
            </div>
        </section>

        <!-- 模块二：动态市场监测 -->
        <section>
            <!-- 模块标题：已更改为“动态市场监测” -->
            <div class="terminal-title rounded-lg">
                <h1 class="text-2xl font-bold font-mono text-anomaly-cyan tracking-widest">
                    <span>动态市场监测</span>
                </h1>
            </div>

            <div class="bg-gray-900 p-6 rounded-xl border border-gray-700 shadow-xl flex flex-col md:flex-row items-center justify-around">
                
                <!-- 饼状图容器 -->
                <div class="w-full md:w-1/2 p-2 max-w-sm flex justify-center">
                    <canvas id="marketShareChart" class="bg-terminal-dark/50 rounded-lg p-4"></canvas>
                </div>
                
                <!-- 阵营信息和描述 -->
                <div class="w-full md:w-1/2 p-2 mt-6 md:mt-0 font-mono text-sm space-y-4">
                    <!-- 移除 H3 标题 -->
                    
                    <ul class="text-gray-300 space-y-2">
                        <!-- 列表项已更新，移除 (可追踪) -->
                        <li>
                            <span class="inline-block w-3 h-3 rounded-full bg-anomaly-cyan mr-2"></span>
                            <strong class="text-anomaly-cyan">三角机构:</strong> 25%
                        </li>
                        <!-- 列表项已更新，更改为 未知企业实体 并移除 (未探知) -->
                        <li>
                            <span class="inline-block w-3 h-3 rounded-full bg-anomaly-red mr-2"></span>
                            <strong class="text-anomaly-red">？？？:</strong> 75%
                        </li>
                    </ul>

                    <!-- 警告文本已更新 -->
                    <p class="mt-4 p-3 bg-gray-700/50 rounded-lg border-l-4 border-yellow-500 text-sm italic text-gray-400">
                        当前网络仅能确定**三角机构**占据 25% 的已知市场份额。其余 75% 仍归属为未知企业实体。
                    </p>
                </div>
            </div>
        </section>

        <!-- 模块三：机密档案库 (外部容器) -->
        <section>
            <!-- 模块标题：添加 flex 和 justify-between 将锁定状态推到右侧 -->
            <div id="archive-header" class="terminal-title rounded-lg cursor-pointer hover:bg-gray-900 transition-colors duration-200" onclick="showPasswordModal()">
                <h1 class="text-2xl font-bold font-mono text-anomaly-cyan tracking-widest flex justify-between items-center w-full">
                    <span>机密档案库</span>
                    <span id="lock-status" class="text-red-500 text-sm ml-2">[ 权限锁定 ]</span>
                </h1>
            </div>

            <!-- 档案库内容，初始隐藏 -->
            <div id="archive-content" class="hidden">
                <div id="archives-grid" class="grid md:grid-cols-3 gap-6">
                    <!-- 档案 1: 碎裂星云 -->
                    <div class="archive-card bg-gray-900 rounded-xl overflow-hidden cursor-pointer border border-anomaly-cyan/30">
                        <div class="p-4">
                            <h4 class="text-lg font-bold text-anomaly-red mb-2">档案: S-77</h4>
                            <p class="text-sm text-gray-500 mb-3">碎裂星云事件报告</p>
                            <p class="text-xs text-gray-400 line-clamp-3"><span class="text-yellow-400">摘要:</span> 2012年11月，在欧洲上空监测到无法解释的重力场波动，导致短暂的物理定律松弛。</p>
                        </div>
                        <!-- 弹出页面按钮 -->
                        <button class="expand-button w-full bg-gray-800 py-2 text-sm text-anomaly-cyan hover:bg-anomaly-cyan hover:text-terminal-dark transition-colors duration-200" onclick="openArchiveModal('archive1')">弹出页面</button>
                    </div>

                    <!-- 档案 2: 非物质信使 -->
                    <div class="archive-card bg-gray-900 rounded-xl overflow-hidden cursor-pointer border border-anomaly-cyan/30">
                        <div class="p-4">
                            <h4 class="text-lg font-bold text-anomaly-red mb-2">档案: P-19</h4>
                            <p class="text-sm text-gray-500 mb-3">非物质信使实验记录</p>
                        </div>
                        <!-- 弹出页面按钮 -->
                        <button class="expand-button w-full bg-gray-800 py-2 text-sm text-anomaly-cyan hover:bg-anomaly-cyan hover:text-terminal-dark transition-colors duration-200" onclick="openArchiveModal('archive2')">弹出页面</button>
                    </div>

                    <!-- 档案 3: 循环梦境 -->
                    <div class="archive-card bg-gray-900 rounded-xl overflow-hidden cursor-pointer border border-anomaly-cyan/30">
                        <div class="p-4">
                            <h4 class="text-lg font-bold text-anomaly-red mb-2">档案: M-04</h4>
                            <p class="text-sm text-gray-500 mb-3">循环梦境个体评估</p>
                            <p class="text-xs text-gray-400 line-clamp-3"><span class="text-yellow-400">摘要:</span> 对一名声称每天晚上都在同一个地点、做同一件事（吃一个不存在的苹果）的个体的评估。</p>
                        </div>
                        <!-- 弹出页面按钮 -->
                        <button class="expand-button w-full bg-gray-800 py-2 text-sm text-anomaly-cyan hover:bg-anomaly-cyan hover:text-terminal-dark transition-colors duration-200" onclick="openArchiveModal('archive3')">弹出页面</button>
                    </div>
                </div>
            </div>
        </section>

    </main>
    
    <!-- 弹出页面 (Modal/Dialog) 结构 -->
    <dialog id="archiveModal" class="p-6 rounded-2xl shadow-2xl backdrop:bg-black/80 bg-gray-900 border border-anomaly-cyan/80 w-11/12 max-w-3xl text-gray-100">
        <div class="flex justify-between items-start mb-4 border-b border-gray-700 pb-3">
            <h3 id="modalTitle" class="text-2xl font-bold text-anomaly-cyan">档案标题</h3>
            <button onclick="closeModal('archiveModal')" class="text-3xl font-light text-gray-400 hover:text-anomaly-red transition-colors ml-4">&times;</button>
        </div>
        <div class="pt-4 space-y-4">
            <p id="modalContent" class="text-gray-300 whitespace-pre-wrap leading-relaxed font-mono text-sm"></p>
            <p class="text-xs italic text-yellow-500 bg-gray-800 p-3 rounded-lg border-l-2 border-yellow-500">
                <span class="font-semibold">注意：</span>此档案已按您的要求以“弹出页面” (Pop-up) 格式显示。
            </p>
        </div>
        <div class="mt-6 text-right">
            <button onclick="closeModal('archiveModal')" class="px-6 py-2 bg-anomaly-red text-white font-semibold rounded-lg hover:bg-red-500 transition duration-200">
                [ 关闭档案 ]
            </button>
        </div>
    </dialog>

    <!-- 密码输入模态框 (新增) -->
    <dialog id="passwordModal" class="p-6 rounded-2xl shadow-2xl backdrop:bg-black/80 bg-gray-900 border border-anomaly-red/80 w-11/12 max-w-md text-gray-100 font-mono">
        <div class="flex justify-between items-start mb-4 border-b border-gray-700 pb-3">
            <h3 class="text-2xl font-bold text-anomaly-red">权限验证</h3>
            <button onclick="closeModal('passwordModal')" class="text-3xl font-light text-gray-400 hover:text-anomaly-red transition-colors ml-4">&times;</button>
        </div>
        
        <p class="text-sm text-gray-400 mb-4">需要输入高权限访问密钥以访问机密档案库。</p>
        
        <div class="space-y-4">
            <input type="password" id="passwordInput" placeholder="输入访问密钥" 
                   class="w-full p-3 bg-terminal-dark border-2 border-gray-700 text-anomaly-cyan focus:border-anomaly-cyan rounded-lg transition-colors placeholder-gray-500"
                   onkeydown="if(event.key === 'Enter') validatePassword()">
            
            <p id="password-message" class="text-sm text-red-400 min-h-5"></p>

            <!-- 移除 [取消] 按钮，只保留确认按钮 -->
            <div class="flex justify-end space-x-3">
                <button onclick="validatePassword()" class="px-6 py-2 bg-anomaly-cyan text-terminal-dark font-semibold rounded-lg hover:bg-cyan-300 transition duration-200">
                     确认 
                </button>
            </div>
        </div>
    </dialog>


    <!-- JavaScript 逻辑 -->
    <script>
        // --- 全局常量和变量 ---
        const TIME_DISPLAY = document.getElementById('time-display');
        const DATE_COMPONENT = document.getElementById('date-component');
        const TIME_COMPONENT = document.getElementById('time-component');
        const MS_COMPONENT = document.getElementById('ms-component');
        const START_BUTTON = document.getElementById('start-button');
        // const LOADING_CONTAINER = document.getElementById('loading-container'); // REMOVED
        // const LOADING_BAR = document.getElementById('loading-bar'); // REMOVED
        // const LOADING_PERCENT = document.getElementById('loading-percent'); // REMOVED
        const BUTTON_TEXT_SPAN = document.getElementById('button-text');
        const TITLE_SCREEN = document.getElementById('title-screen');
        const MAIN_CONTENT = document.getElementById('main-content');
        const WELCOME_GREETING = document.getElementById('welcome-greeting');
        
        // Modal 元素
        const ARCHIVE_MODAL = document.getElementById('archiveModal');
        const MODAL_TITLE = document.getElementById('modalTitle');
        const MODAL_CONTENT = document.getElementById('modalContent');
        
        // 密码和档案库元素
        const PASSWORD_MODAL = document.getElementById('passwordModal');
        const PASSWORD_INPUT = document.getElementById('passwordInput');
        const PASSWORD_MESSAGE = document.getElementById('password-message');
        const ARCHIVE_CONTENT = document.getElementById('archive-content');
        const LOCK_STATUS = document.getElementById('lock-status');
        const CORRECT_PASSWORD = '199933333333';


        let glitchInterval;
        let loadingProgress = 0;
        const TARGET_YEAR = 2012;
        const TARGET_MONTH = 11; 
        
        // --- 进度条颜色常量 ---
        const LOADING_FILL_COLOR = '#33ccff'; // anomaly-cyan
        const LOADING_EMPTY_COLOR = '#374151'; // gray-700
        const SUCCESS_COLOR = 'rgb(34, 197, 94)'; // green-500

        // --- 数据存储 (机密档案) ---
        const ARCHIVE_DATA = {
            archive1: { title: "档案 S-77: 碎裂星云事件报告", text: "记录日期: 2012年11月22日 04:47:11\n\n[机密等级: 5/5 - 绝对不可知]\n\n事件摘要：位于格陵兰海的监测站记录到时空结构出现局部撕裂，持续时间约为4.3秒。目击者（一名渔民，代号'Maelstrom'）报告天空在撕裂期间呈现出'一万个时钟'同时破碎的景象。\n\n分析：重力常数在撕裂期间波动了±0.00000001%。这足以导致水分子在短时间内无法保持液态。任何企图通过常规手段理解此次事件的尝试都被判定为高风险的认知污染。建议将此档案标记为'非事件'，并在所有官方记录中将其替换为'天气反常'。" },
            archive2: { title: "档案 P-19: 非物质信使实验记录", text: "记录日期: 2012年11月10日 11:59:00\n\n[机密等级: 3/5 - 需授权]\n\n实验目的：捕获并分析代号'低语'的非物质信使。信使不遵循任何已知宇宙定律，通过潜意识共振传递信息。\n\n实验结果：信使传递的信息被探员L-03记录为一串二进制代码。解码后得到：'他们看到了你'。随后，L-03的手部开始出现不可控的、无规律的震颤。此震颤与心跳或呼吸均不相关。L-03已被隔离，信使被判定为具有高认知侵入性。实验终止，建议将所有捕获尝试降级为被动监测。" },
            archive3: { title: "档案 M-04: 循环梦境个体评估", text: "记录日期: 2012年11月05日 19:30:00\n\n[机密等级: 4/5 - 敏感]\n\n个体代号: '锚点'\n\n评估：锚点是一个活生生的、自洽的时间循环。他所处的梦境（位于一个不存在的灰色小镇，始终在一家咖啡馆里吃苹果）是他时间线中唯一稳定的点。如果锚点被唤醒或打破循环，该时间线将面临不可预测的重写风险。评估建议：保持距离，被动观察。如果他向你提及任何关于'正确的时钟'的信息，立即终止对话。" }
        };

        // --- 新增：补给仓库物品数据 ---
        const SUPPLY_DATA = [
            {
                id: "A-01",
                title: "游戏地图",
                award: 25,
                series: "A",
                description: "一张以携带者为中心，半径500m，随移动实时更新的像素风格地图。可以显示附近道路、墙壁、河流、房间等的基本布局。地图范围内的平凡生命会以小人图标标记，并标出其视野范围。",
                effects: [
                    "标记一个目标持续跟踪其位置（超出范围会以箭头标记大概方向）",
                    "显示两点之间的一条较短可用道路",
                    "原地建立传送锚点",
                    "在明显的10秒读条效果后前往传送锚点"
                ]
            },
            {
                id: "A-02",
                title: "雪王喷雾",
                award: 15,
                series: "A",
                description: "外观为一个正常喷漆罐，上面印有雪王卡通图案。内部充满异常制冷剂，常温下为液体。一旦从喷嘴喷出降压，制冷剂会立即汽化，并吸收大量热能，瞬间冻结目标。",
                effects: [
                    "冰冻效果持续 5 秒。",
                    "喷雾最多使用 4 次，使用完后，需等待 24 小时进行内部充能。"
                ],
                risk: "若喷漆罐因受损炸裂，则对范围 10 米内所有生物及物品进行冰封，持续时间 3 秒。此状况下的喷雾无法回收。"
            },
            {
                id: "A-03",
                title: "降温蛋筒",
                award: 4,
                series: "A",
                description: "外观是个普通的冰淇淋蛋筒，但实际上不易受外力（不超过普通男性人类用力挥出的一拳）破坏。",
                effects: [
                    "蛋筒外缘是稳定的零下 18°C（保存冰淇淋的最佳温度！）。",
                    "能够将 200ml 的开水在 10 秒内冻结。"
                ]
            },
            {
                id: "A-04",
                title: "一斤鸭梨",
                award: 6,
                series: "A",
                description: "三个网兜装着的鸭梨，大小形状可能都不太一样，但三个的总重量一定是精准的 500g 重。它们真的很好吃。",
                effects: [
                    "任何吃下鸭梨或含梨汁食品的人（生效的浓度最少 1:3）都会沉溺于回忆之中，并变得极度充满倾诉欲。",
                    "这三个鸭梨如果分离超过 24 小时就会变成普通的鸭梨。"
                ]
            },
            {
                id: "A-05",
                title: "很coooool的暴风雪桶",
                award: 6,
                series: "A",
                description: "一个印着三角形 logo，写着“暴风雪冰淇淋”的很 coooooool 的冰淇淋桶，看上去只是一个很 coooooool 的大份冰淇淋。",
                effects: [
                    "打开之后就会有一团暴风雪冲出来。",
                    "被暴风雪覆盖的人会觉得一切都变得很 coooooool，哪怕出现再奇怪的事情也不妨碍他们赞叹一声“cool”然后继续做自己的事情。"
                ]
            },
            {
                id: "A-06",
                title: "红油辣椒冰淇淋",
                award: "2",
                series: "A",
                description: "一个淋满了红油的大圣代，以至于看起来像冰淇淋新装的火锅底料。",
                effects: [
                    "服用后会在 1 小时内将你的体温稳定在 36 摄氏度。",
                    "服用后瞬间增重 10 斤，并在后续的一个小时内消耗你的体重 20 斤。"
                ],
                risk: "在食用后即使是超人来了也抵抗不住的冷热交替，必定会引起腹泻或相关肠道疾病，还会让你的痔疮像爱人的心跳一样火热，如果没有，它会奖励你一个的。"
            },
            {
                id: "A-07",
                title: "沉默的八音盒",
                award: 4,
                series: "A",
                description: "一个八音盒，打开时，会弹出一个缓慢旋转的指挥家塑像，塑像有着白色手套。",
                effects: [
                    "附近 5m 的除了特工的凡俗心智会感到抑郁而想要回到自己的住处或者安全的角落独自伤感，这种伤感来自于自身回忆，因而不会产生松散端。",
                    "持续时间为一分钟的沉默歌曲结束后，指挥家会停止转动，八音盒将再也不能使用，陷入永远的沉默。"
                ]
            },
            {
                id: "A-08",
                title: "素质柠檬水",
                award: 12,
                series: "A",
                description: "这是杯清爽解腻的柠檬水共 32盎司，可以随时为你让你保持干劲和好心情。",
                effects: [
                    "饮用一杯可以清空一点异常状态。",
                    "若饮用时嚼碎吞服柠檬片（极其酸涩），则可以瞬间恢复 1 点素质保障。"
                ],
                risk: "为了保护环境，请不要随手扔杯子以及注意表情管理。"
            },
            {
                id: "A-09",
                title: "雪景球",
                award: "3",
                series: "A",
                description: "外观：一个内置一根冰淇淋的雪景球，摇晃时会发出音乐。",
                effects: [
                    "当你剧烈摇晃时，除你和你指定的目标外，任何平凡生物都会感觉到刺骨的寒意并放下手中的事，立刻朝着最近的温暖源跑去，并在那里停留 5 分钟。",
                    "范围：为以使用者为中心半径 25 米的球形。",
                    "收到影响者不会因该能力产生松散端。"
                ]
            },
            {
                id: "B-01",
                title: "虫虫软糖",
                award: "1",
                series: "B",
                description: "蠕虫形裹糖粉彩色软糖，长约25cm~33cm不等，通常为亮绿色，尝起来有一股浓郁的菠萝和轻微电子仪器的味道。",
                effects: [
                    "手持一条虫虫软糖，用头部和尾部分部连接想要连接的两台电子设备，可以轻松的在两台设备中移动任何你选择的文件。",
                    "每条离开包装袋的虫虫软糖最多存在24小时，使用完的虫虫软糖请尽快食用。"
                ],
                note: "【特别鸣谢：碧玉分部】"
            }
        ];

        // --- 核心功能: 时间和故障效果 (仅保留随机数字和颜色切换) ---

        function generateGlitchTime() {
            const now = new Date();
            const randomYear = Math.floor(Math.random() * 9000) + 1000;
            const randomMonth = String(Math.floor(Math.random() * 100)).padStart(2, '0');
            const randomDay = String(Math.floor(Math.random() * 100)).padStart(2, '0');
            
            const currentHour = String(now.getHours()).padStart(2, '0');
            const currentMinute = String(now.getMinutes()).padStart(2, '0');
            const randomSecond = String(Math.min(59, Math.max(0, now.getSeconds() + Math.floor(Math.random() * 10) - 5))).padStart(2, '0');
            
            const randomMs = String(Math.floor(Math.random() * 1000)).padStart(3, '0');

            DATE_COMPONENT.textContent = `${randomYear}-${randomMonth}-${randomDay}`;
            TIME_COMPONENT.textContent = `${currentHour}:${currentMinute}:${randomSecond}`;
            MS_COMPONENT.textContent = `.${randomMs}`;

            // 随机切换颜色 (保留这一步来模拟不稳定状态)
            if (Math.random() < 0.5) {
                TIME_DISPLAY.classList.replace('text-anomaly-red', 'text-anomaly-cyan');
            } else {
                TIME_DISPLAY.classList.replace('text-anomaly-cyan', 'text-anomaly-red');
            }
        }

        function startGlitch() {
            glitchInterval = setInterval(generateGlitchTime, 50); 
        }

        function stabilizeTime(targetMonth) {
            clearInterval(glitchInterval);

            // 移除随机颜色切换，稳定为白色
            TIME_DISPLAY.classList.remove('text-anomaly-red', 'text-anomaly-cyan');
            TIME_DISPLAY.classList.add('text-white');
            
            const now = new Date();
            // 稳定时间到 2012 年 11 月
            const stableDate = new Date(TARGET_YEAR, targetMonth - 1, now.getDate(), now.getHours(), now.getMinutes(), now.getSeconds(), now.getMilliseconds());
            
            const year = stableDate.getFullYear();
            const month = String(stableDate.getMonth() + 1).padStart(2, '0'); 
            const day = String(stableDate.getDate()).padStart(2, '0');
            const hour = String(stableDate.getHours()).padStart(2, '0');
            const minute = String(stableDate.getMinutes()).padStart(2, '0');
            const second = String(stableDate.getSeconds()).padStart(2, '0');

            DATE_COMPONENT.textContent = `${year}-${month}-${day}`;
            TIME_COMPONENT.textContent = `${hour}:${minute}:${second}`;
            MS_COMPONENT.textContent = '.000';
            
            TIME_DISPLAY.parentElement.classList.replace('border-anomaly-cyan', 'border-gray-500');
        }
        
        /**
         * 生成 4 到 6 位的随机乱码（数字、英文、特殊字符）
         */
        function generateGarbledCode() {
            // 包含数字、大写/小写字母和常见特殊字符
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+-=[]{}|;:,.<>?';
            const length = Math.floor(Math.random() * 3) + 4; // 4 to 6 characters
            let code = '';
            for (let i = 0; i < length; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        /**
         * 生成并设置欢迎语，包含随机乱码
         */
        function generateAndSetGreeting() {
            if (WELCOME_GREETING) {
                const code = generateGarbledCode();
                // **修改点 1: 欢迎语从“访客”改为“特工”**
                WELCOME_GREETING.textContent = `欢迎，特工 [ ${code} ]。您的访问操作已被记录。`;
            }
        }


        /**
         * 处理按钮点击和加载过程
         */
        function handleStart() {
            // 重置按钮样式（如果之前加载过）
            if (START_BUTTON.classList.contains('loading-state') || START_BUTTON.classList.contains('bg-green-500')) {
                 // 1. 重置页面状态
                 MAIN_CONTENT.classList.add('opacity-0', 'pointer-events-none');
                 TITLE_SCREEN.style.display = 'flex';
                 TITLE_SCREEN.style.opacity = '1';
                 TITLE_SCREEN.style.pointerEvents = 'auto';
                 
                 // 2. 重置加载状态
                 loadingProgress = 0;
                 START_BUTTON.disabled = false; // 重新启用按钮
                 
                 // 3. 重置按钮视觉
                 START_BUTTON.style.backgroundImage = 'none';
                 START_BUTTON.classList.remove('loading-state', 'bg-green-500');
                 // 恢复到初始状态的颜色和悬停效果
                 START_BUTTON.classList.add('bg-anomaly-cyan', 'hover:bg-cyan-300');
                 BUTTON_TEXT_SPAN.textContent = '访问权限请求';
                 
                 return; // 阻止后续逻辑，等待下一次点击
            }
            
            // 切换到加载状态
            START_BUTTON.disabled = true;
            START_BUTTON.classList.remove('bg-anomaly-cyan', 'hover:bg-cyan-300', 'active:scale-95');
            START_BUTTON.classList.add('bg-gray-700', 'loading-state');
            
            // 隐藏旧的加载容器 (如果它仍存在)
            const loadingContainer = document.getElementById('loading-container');
            if (loadingContainer) loadingContainer.classList.add('hidden'); 

            const totalDuration = 3000; 
            const steps = 100;
            const intervalTime = totalDuration / steps;

            const loadingInterval = setInterval(() => {
                loadingProgress++;
                const widthPercent = Math.min(100, loadingProgress);
                
                // --- 核心修改：使用 linear-gradient 作为进度条 ---
                START_BUTTON.style.backgroundImage = `linear-gradient(to right, ${LOADING_FILL_COLOR} 0%, ${LOADING_FILL_COLOR} ${widthPercent}%, ${LOADING_EMPTY_COLOR} ${widthPercent}%, ${LOADING_EMPTY_COLOR} 100%)`;
                
                // 更新按钮文本显示百分比
                BUTTON_TEXT_SPAN.textContent = `协议激活中... ${widthPercent}%`;
                // --- 核心修改结束 ---

                if (loadingProgress >= 100) {
                    clearInterval(loadingInterval);
                    
                    // 加载完成后的操作
                    // 1. 最终视觉效果：纯绿色成功背景
                    START_BUTTON.style.backgroundImage = 'none';
                    START_BUTTON.classList.remove('loading-state', 'bg-gray-700');
                    START_BUTTON.classList.add('bg-green-500');
                    BUTTON_TEXT_SPAN.textContent = '访问成功';
                    
                    // 2. 停止故障并稳定时间
                    stabilizeTime(11); 
                    
                    // 3. 新增：生成并设置欢迎语中的随机乱码
                    generateAndSetGreeting();

                    // 4. 页面切换逻辑：隐藏标题页，显示主内容
                    setTimeout(() => {
                        // 淡出标题页
                        TITLE_SCREEN.style.opacity = '0';
                        TITLE_SCREEN.style.pointerEvents = 'none';
                        
                        // 显示并淡入主内容
                        MAIN_CONTENT.classList.remove('opacity-0', 'pointer-events-none');

                        // 移除 fixed 定位，让文档流恢复正常，以便滚动
                        setTimeout(() => {
                            TITLE_SCREEN.style.display = 'none';
                            document.getElementById('scroll-indicator').classList.remove('hidden');
                        }, 1000); 

                    }, 800);
                }
            }, intervalTime);
        }
        
        // --- 补给仓库渲染逻辑 (已更新以支持模块分组) ---
        /**
         * 动态渲染补给仓库中的所有物品列表
         */
        function renderSupplyWarehouse() {
            const container = document.getElementById('supply-list-container');
            if (!container) return;

            // 1. Group Data
            const moduleAItems = SUPPLY_DATA.filter(item => item.series === 'A');
            const moduleBItems = SUPPLY_DATA.filter(item => item.series === 'B');

            let html = '';

            /**
             * Helper function to render individual item details (A-01, B-01, etc.)
             */
            const renderItems = (items) => {
                let itemHtml = '';
                items.forEach(item => {
                    const isBSeries = item.series === 'B';
                    // 统一容器类名
                    const containerClasses = `bg-gray-800 rounded-lg overflow-hidden transition-all duration-300 border ${isBSeries ? 'border-gray-700/50 item-container-b' : 'border-gray-700/50'}`;
                    const titleClasses = `item-summary-title ${isBSeries ? 'item-summary-title-b' : ''}`;
                    const idClasses = `item-summary-id`;
                    const indicatorColor = isBSeries ? 'text-anomaly-red' : 'text-yellow-300';
                    const summaryBg = 'hover:bg-gray-700';
                    const detailBorderColor = isBSeries ? 'border-gray-700/50' : 'border-gray-700/50';

                    let detailContent = '';

                    // 嘉奖消耗
                    detailContent += `
                        <div class="mb-4 py-1 px-3 bg-gray-900 border-b border-t border-anomaly-red font-mono flex justify-between items-center rounded-md">
                            <span class="text-xs text-anomaly-cyan uppercase tracking-widest">:: 嘉奖消耗 ::</span>
                            <span class="text-xl font-bold text-anomaly-red">${item.award}</span>
                        </div>
                    `;
                    
                    // 描述
                    detailContent += `<p class="text-sm leading-relaxed mb-3">${item.description}</p>`;
                    
                    // 效果列表
                    if (item.effects && item.effects.length > 0) {
                        detailContent += `<ul class="text-sm list-none pl-4 space-y-1 mb-3">`;
                        item.effects.forEach(effect => {
                            detailContent += `
                                <li class="flex items-start">
                                    <span class="text-green-400 mr-2 mt-px text-sm">►</span>
                                    <span>${effect}</span>
                                </li>
                            `;
                        });
                        detailContent += `</ul>`;
                    }

                    // 风险/注意事项
                    if (item.risk) {
                        detailContent += `
                            <p class="text-sm leading-relaxed">
                                <span class="text-anomaly-red font-bold">${item.series === 'A' ? '泄露风险:' : '副作用:'}</span> ${item.risk}
                            </p>
                        `;
                    }
                    
                    // 特别鸣谢
                    if (item.note) {
                        detailContent += `
                            <p class="text-xs text-yellow-500 font-bold text-right italic">
                                ${item.note}
                            </p>
                        `;
                    }

                    // 组装完整的 details 块
                    itemHtml += `
                        <details class="${containerClasses}">
                            <summary class="flex justify-between items-center p-3 cursor-pointer ${summaryBg} transition-colors duration-200 font-bold">
                                <div class="${titleClasses}">
                                    <span class="${idClasses}">[ ${item.id} ]</span> 
                                    <span>${item.title}</span>
                                </div>
                                <!-- 展开指示器 -->
                                <span class="text-sm transform transition-transform duration-300 summary-indicator ${indicatorColor}">▼</span>
                            </summary>
                            <div class="p-4 bg-gray-800/80 text-gray-400 border-t ${detailBorderColor}">
                                ${detailContent}
                            </div>
                        </details>
                    `;
                });
                return itemHtml;
            };

            
            /**
             * Function to wrap item details in a collapsible module (Module A or B)
             * @param {string} title 模块标题
             * @param {Array<Object>} items 模块包含的物品列表
             * @param {boolean} defaultOpen 模块是否默认展开
             */
            const renderModule = (title, items, defaultOpen = false) => { 
                const moduleHtml = renderItems(items);
                if (moduleHtml.length === 0) return ''; // Skip if no items

                // 模块默认关闭，不需要 'open' 属性
                const openAttribute = defaultOpen ? 'open' : ''; 

                return `
                    <!-- 模块 A/B 折叠容器 -->
                    <details class="module-group bg-terminal-dark/80 rounded-xl border border-anomaly-cyan/30 overflow-hidden shadow-lg" ${openAttribute}>
                        <summary class="p-4 bg-terminal-dark hover:bg-gray-800 cursor-pointer font-bold text-lg text-anomaly-cyan flex justify-between items-center transition-colors duration-200">
                            <span>${title}</span>
                            <!-- 使用 ▼ 图标和 rotation-180 实现 ▲/▼ 切换 -->
                            <span class="module-indicator text-xl transform transition-transform duration-300">▼</span>
                        </summary>
                        <!-- 模块内容（内部包含物品详情列表） -->
                        <div class="p-2 space-y-3">
                            ${moduleHtml}
                        </div>
                    </details>
                `;
            };

            // 2. Render Modules
            // Module A: 默认关闭
            html += renderModule("模块 A", moduleAItems);
            
            // Module B: 默认关闭 
            html += renderModule("模块 B", moduleBItems);


            // 3. Update container HTML
            container.innerHTML = html;
            
            // 渲染完成后，重新绑定 details 箭头翻转逻辑
            setupDetailsToggle();
            setupModuleToggle(); // 绑定模块 A/B 的切换逻辑
        }


        // --- Details 箭头翻转逻辑 (物品详情) ---
        function setupDetailsToggle() {
            document.querySelectorAll('details').forEach(details => {
                // 确保只添加一次事件监听器，避免重复调用
                if (!details.dataset.listenerAdded) {
                    details.addEventListener('toggle', () => {
                        const indicator = details.querySelector('.summary-indicator');
                        if (indicator) {
                            if (details.open) {
                                indicator.style.transform = 'rotate(180deg)';
                            } else {
                                indicator.style.transform = 'rotate(0deg)';
                            }
                        }
                    });
                    details.dataset.listenerAdded = 'true'; // 标记已添加
                    // 初始设置
                    const indicator = details.querySelector('.summary-indicator');
                    if (indicator) {
                         if (details.open) {
                            indicator.style.transform = 'rotate(180deg)';
                        } else {
                            indicator.style.transform = 'rotate(0deg)';
                        }
                    }
                }
            });
        }
        
        // --- 模块 A/B 折叠逻辑 ---
        function setupModuleToggle() {
            document.querySelectorAll('.module-group').forEach(details => {
                // Find the indicator within the summary
                const indicator = details.querySelector('.module-indicator');
                
                // Only set up listeners once
                if (!details.dataset.moduleListenerAdded) {
                    
                    // Event listener for toggle
                    details.addEventListener('toggle', () => {
                        if (indicator) {
                            if (details.open) {
                                indicator.style.transform = 'rotate(180deg)';
                            } else {
                                indicator.style.transform = 'rotate(0deg)';
                            }
                        }
                    });
                    details.dataset.moduleListenerAdded = 'true'; // Mark as set up
                }
                
                // Initial setup for rotation
                if (indicator) {
                    if (details.open) {
                        indicator.style.transform = 'rotate(180deg)';
                    } else {
                        indicator.style.transform = 'rotate(0deg)';
                    }
                }
            });
        }


        // --- 市场份额饼状图 Chart.js 逻辑 ---
        function setupMarketShareChart() {
            const ctx = document.getElementById('marketShareChart');
            
            const chartData = {
                // 更改饼状图标签以匹配新的文本
                labels: ['三角机构 (25%)', '？？？ (75%)'], 
                datasets: [{
                    data: [25, 75], // 25% for Triangular Agency, 75% for ???
                    backgroundColor: [
                        '#33ccff', // anomaly-cyan
                        '#ff3366'  // anomaly-red
                    ],
                    hoverOffset: 10,
                    borderWidth: 2,
                    borderColor: '#1a1a2e' // liminal-bg
                }]
            };

            const chartOptions = {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#D1D5DB', // gray-300
                            font: {
                                size: 14,
                                family: 'Courier Prime'
                            },
                            boxWidth: 20
                        }
                    },
                    title: {
                        display: false,
                    }
                }
            };

            new Chart(ctx, {
                type: 'doughnut',
                data: chartData,
                options: chartOptions
            });
        }


        // --- 弹出页面 (Modal) 逻辑 ---
        
        /**
         * 显示模态窗口（弹出页面）
         * @param {string} archiveId 档案 ID (key in ARCHIVE_DATA)
         */
        function openArchiveModal(archiveId) {
            // 只有档案库解锁后才能打开档案
            if (ARCHIVE_CONTENT.classList.contains('hidden')) {
                showPasswordModal(); // 提示用户先解锁
                return;
            }

            const data = ARCHIVE_DATA[archiveId];
            if (data) {
                MODAL_TITLE.textContent = data.title;
                MODAL_CONTENT.textContent = data.text;
                ARCHIVE_MODAL.showModal();
            } else {
                // 仅在控制台显示错误，不使用 alert
                console.error("Archive data not found for ID:", archiveId);
            }
        }

        /**
         * 关闭模态窗口
         * @param {string} modalId 要关闭的模态框 ID
         */
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal && modal.open) {
                modal.close();
            }
            // 清理密码输入框状态
            if (modalId === 'passwordModal') {
                PASSWORD_INPUT.value = '';
                PASSWORD_INPUT.classList.remove('password-shake');
                PASSWORD_MESSAGE.textContent = '';
            }
        }
        
        // 允许用户点击 backdrop 关闭 modal (对所有 dialog 生效)
        document.querySelectorAll('dialog').forEach(dialog => {
            dialog.addEventListener('click', (e) => {
                const rect = dialog.getBoundingClientRect();
                if (e.clientX < rect.left || e.clientX > rect.right || 
                    e.clientY < rect.top || e.clientY > rect.bottom) {
                    dialog.close();
                }
                // 清理密码输入框状态
                if (dialog.id === 'passwordModal') {
                    PASSWORD_INPUT.value = '';
                    PASSWORD_INPUT.classList.remove('password-shake');
                    PASSWORD_MESSAGE.textContent = '';
                }
            });
        });


        // --- 机密档案库密码验证逻辑 (新增) ---
        
        function showPasswordModal() {
            // 如果档案库已解锁，则直接返回，不显示密码框
            if (!ARCHIVE_CONTENT.classList.contains('hidden')) {
                return;
            }
            
            PASSWORD_MODAL.showModal();
            // 确保输入框获得焦点
            PASSWORD_INPUT.focus();
        }

        function validatePassword() {
            const enteredPassword = PASSWORD_INPUT.value.trim();
            
            // 清除之前的动画和信息
            PASSWORD_INPUT.classList.remove('password-shake');
            PASSWORD_MESSAGE.textContent = '';
            
            if (enteredPassword === CORRECT_PASSWORD) {
                // 密码正确
                closeModal('passwordModal');
                unlockArchives();
            } else {
                // 密码错误：添加抖动效果、错误信息和视觉强调
                PASSWORD_MESSAGE.textContent = '[ 验证失败 ] 访问密钥不正确。';
                PASSWORD_INPUT.classList.add('password-shake');
                
                // 移除抖动类和视觉强调，以便下次可以再次触发动画
                setTimeout(() => {
                    PASSWORD_INPUT.classList.remove('password-shake');
                    // 注意: Tailwind 的 focus 样式会在移除 password-shake 后自动恢复
                }, 500);
            }
            // 清空输入框以重新尝试
            PASSWORD_INPUT.value = '';
        }
        
        function unlockArchives() {
            // 1. 显示档案内容
            ARCHIVE_CONTENT.classList.remove('hidden');
            
            // 2. 更新锁定状态文本
            LOCK_STATUS.textContent = '[ 访问授权 ]';
            LOCK_STATUS.classList.remove('text-red-500');
            LOCK_STATUS.classList.add('text-green-500');
            
            // 3. 移除标题的点击光标，表示已解锁
            document.getElementById('archive-header').classList.remove('cursor-pointer', 'hover:bg-gray-900');
            document.getElementById('archive-header').onclick = null; // 移除点击事件
        }


        // --- 初始化 ---
        window.onload = function() {
            startGlitch(); // 启动不稳定的时间动画 (仅数字/颜色切换)
            START_BUTTON.addEventListener('click', handleStart);
            setupMarketShareChart(); // 启动饼状图
            renderSupplyWarehouse(); // 动态渲染补给仓库
        }

        
    </script>
</body>
</html>